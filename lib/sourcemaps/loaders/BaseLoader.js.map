{"version":3,"sources":["loaders/BaseLoader.js"],"names":["_","require","development_core_1","requireDir","chalk","BaseLoader","option","_classCallCheck","this","getTaskDefine","def","moduleTaskLoader","cfg","mdl","_this","getTaskModule","loadTaskFromModule","catch","err","console","error","oper","then","moduleTaskConfig","env","config","bindingConfig","_this3","findTasksInDir","dirs","findTasksInModule","tsdef","loader","taskDefine","findTaskDefine","loadTaskFromDir","Promise","resolve","reject","ml","module","isString","isTaskDefine","each","keys","f","exceptObj","arguments","length","undefined","isTaskFunc","isFunction","_this5","tasks","push","isArray","sm","concat","findTasks","key","test","grey","cyan","taskfuns","_this6","all","map","dir","recurse"],"mappings":"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","file":"../../loaders/BaseLoader.js","sourcesContent":["\"use strict\";\nconst _ = require('lodash');\nconst development_core_1 = require('development-core');\nconst requireDir = require('require-dir');\nconst chalk = require('chalk');\nclass BaseLoader {\n    constructor(option) {\n        this.option = option;\n    }\n    load(cfg) {\n        return this.getTaskDefine()\n            .then(def => {\n            if (def.moduleTaskLoader) {\n                return def.moduleTaskLoader(cfg);\n            }\n            else {\n                let mdl = this.getTaskModule();\n                return this.loadTaskFromModule(mdl);\n            }\n        })\n            .catch(err => {\n            console.error(err);\n        });\n    }\n    loadConfg(oper, env) {\n        return this.getTaskDefine()\n            .then(def => {\n            return def.moduleTaskConfig(oper, this.option, env);\n        })\n            .then(config => {\n            return this.bindingConfig(config);\n        })\n            .catch(err => {\n            console.error(err);\n        });\n    }\n    bindingConfig(cfg) {\n        cfg = development_core_1.bindingConfig(cfg);\n        cfg.findTasksInDir = cfg.findTasksInDir || ((dirs) => {\n            return this.loadTaskFromDir(dirs);\n        });\n        cfg.findTasksInModule = cfg.findTasksInModule || ((mdl) => {\n            return this.loadTaskFromModule(mdl);\n        });\n        return cfg;\n    }\n    getTaskDefine() {\n        let tsdef = null;\n        let loader = this.option.loader;\n        if (loader.taskDefine) {\n            tsdef = loader.taskDefine;\n        }\n        else {\n            let mdl = this.getConfigModule();\n            tsdef = this.findTaskDefine(mdl);\n        }\n        if (tsdef) {\n            return Promise.resolve(tsdef);\n        }\n        else {\n            return Promise.reject('can not found task define.');\n        }\n    }\n    getConfigModule() {\n        let loader = this.option.loader;\n        let ml = loader.configModule || loader.module;\n        if (_.isString(ml)) {\n            return require(ml);\n        }\n        else {\n            return ml;\n        }\n    }\n    getTaskModule() {\n        let loader = this.option.loader;\n        let ml = loader.taskModule || loader.module;\n        if (_.isString(ml)) {\n            return require(ml);\n        }\n        else {\n            return ml;\n        }\n    }\n    findTaskDefine(mdl) {\n        let def = null;\n        if (this.isTaskDefine(mdl)) {\n            def = mdl;\n        }\n        if (!def && mdl) {\n            _.each(_.keys(mdl), f => {\n                if (def) {\n                    return false;\n                }\n                if (this.isTaskDefine(mdl[f])) {\n                    def = mdl[f];\n                }\n                return true;\n            });\n        }\n        return def;\n    }\n    isTaskDefine(mdl) {\n        if (!mdl) {\n            return false;\n        }\n        let loader = this.option.loader;\n        if (loader.isTaskDefine) {\n            return loader.isTaskDefine(mdl);\n        }\n        return _.isFunction(mdl['moduleTaskConfig']);\n    }\n    isTaskFunc(mdl, exceptObj = false) {\n        if (!mdl) {\n            return false;\n        }\n        let loader = this.option.loader;\n        if (loader.isTaskFunc) {\n            return loader.isTaskFunc(mdl);\n        }\n        if (_.isFunction(mdl)) {\n            return true;\n        }\n        return exceptObj;\n    }\n    findTasks(mdl) {\n        let tasks = [];\n        if (!mdl) {\n            return tasks;\n        }\n        if (this.isTaskFunc(mdl)) {\n            tasks.push(mdl);\n        }\n        else if (!this.isTaskDefine(mdl)) {\n            if (_.isArray(mdl)) {\n                _.each(mdl, sm => {\n                    tasks.concat(this.findTasks(sm));\n                });\n            }\n            else {\n                _.each(_.keys(mdl), key => {\n                    if (!key || !mdl[key] || /^[0-9]+$/.test(key)) {\n                        return;\n                    }\n                    console.log(chalk.grey('register task from :'), chalk.cyan(key));\n                    tasks = tasks.concat(this.findTasks(mdl[key]));\n                });\n            }\n        }\n        return tasks;\n    }\n    loadTaskFromModule(mdl) {\n        let taskfuns = this.findTasks(mdl);\n        return Promise.resolve(taskfuns);\n    }\n    loadTaskFromDir(dirs) {\n        return Promise.all(_.map(_.isArray(dirs) ? dirs : [dirs], dir => {\n            console.log(chalk.grey('begin load task from dir'), chalk.cyan(dir));\n            let mdl = requireDir(dir, { recurse: true });\n            return this.loadTaskFromModule(mdl);\n        }))\n            .then(tasks => {\n            return _.flatten(tasks);\n        });\n    }\n}\nexports.BaseLoader = BaseLoader;\n"]}