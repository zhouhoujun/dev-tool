"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function __export(e){for(var n in e)exports.hasOwnProperty(n)||(exports[n]=e[n])}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),_=require("lodash"),minimist=require("minimist"),LoaderFactory_1=require("./LoaderFactory"),development_core_1=require("development-core"),chalk=require("chalk");__export(require("./LoaderFactory")),__export(require("./loaders/BaseLoader"));var Development=function(){function e(n,t){_classCallCheck(this,e),this.dirname=n,this.option=t,this.globals={}}return _createClass(e,[{key:"run",value:function(e,n){return n.root||(n.root=this.dirname),n.help&&(console.log(chalk.grey("... main help  ...")),this.printHelp(n.help)),this.loadTasks(e,this.option.tasks,n).then(function(n){return console.log(chalk.grey("run sequenec tasks:"),n),development_core_1.runSequence(e,n)}).catch(function(e){console.error(e)})}},{key:"bindingConfig",value:function(e){return e.globals=this.globals,e}},{key:"loadTasks",value:function(e,n,t){var r=this;return Promise.all(_.map(_.isArray(n)?n:[n],function(n){n.dist=n.dist||"dist";var o=development_core_1.currentOperation(t);console.log(chalk.grey("begin load task via loader:"),n.loader);var a=r.createLoader(n);return a.loadConfg(o,t).then(function(n){return console.log(chalk.green("task config loaded.")),n.env.help?(n.printHelp&&(console.log(chalk.grey("...development default help...")),n.printHelp(_.isString(n.env.help)?n.env.help:"")),[]):(n=r.bindingConfig(n),r.loadSubTask(e,n).then(function(t){return Promise.all([a.load(n),r.loadAssertTasks(e,n)]).then(function(o){return console.log(chalk.green("tasks loaded.")),r.setup(e,n,o[0],o[1],t)})}))})})).then(function(e){return _.flatten(e)})}},{key:"setup",value:function(e,n,t,r,o){return Promise.resolve(development_core_1.toSequence(e,t,n)).then(function(e){return n.runTasks?n.runTasks(e,r,o):(n.addToSequence(e,r),n.addToSequence(e,o),e)})}},{key:"loadSubTask",value:function(e,n){var t=this;if(!n.tasks)return Promise.resolve(null);var r=function(){var r=n.option;return _.each(_.isArray(r.tasks)?r.tasks:[r.tasks],function(e){e.name=n.subTaskName(e.name),e.src=e.src||r.src,e.dist=e.dist||r.dist}),{v:t.loadTasks(e,r.tasks,n.env).then(function(t){if(t&&t.length>0){var o=_.first(t),a=_.last(t),s=_.isArray(o)?_.first(o):o,i=_.isArray(a)?_.last(a):a,l=n.subTaskName(s+"-"+i,"-sub");return e.task(l,function(){return development_core_1.runSequence(e,t)}),{order:r.subTaskOrder,name:l}}return null})}}();return"object"===("undefined"==typeof r?"undefined":_typeof(r))?r.v:void 0}},{key:"loadAssertTasks",value:function(e,n){var t=this,r=n.option;if(!n.option.asserts)return Promise.resolve(null);var o=function(){var o=[];return _.each(_.keys(r.asserts),function(e){var t=void 0,a=r.asserts[e];t=_.isString(a)?{src:a,loader:[{name:e,pipes:[]},{name:e+"-watch",watch:[e]}]}:_.isArray(a)?_.some(a,function(e){return _.isString(a)})?{src:a,loader:[{name:e,pipes:[]},{name:e+"-watch",watch:[e]}]}:{loader:a}:a,_.isNull(t)||_.isUndefined(t)||(t.name=n.subTaskName(e,"-assert"),t.src=t.src||r.src+"/**/*."+e,t.dist=t.dist||r.dist,o.push(t))}),{v:Promise.all(_.map(o,function(r){return t.loadTasks(e,r,n.env).then(function(e){return{task:r,sq:e}})})).then(function(t){var r=_.map(t,function(t){var r=t.sq,o=void 0;if(r&&r.length>0){if(1===r.length)return r[0];o=n.subTaskName(t.task),e.task(o,function(){return development_core_1.runSequence(e,r)})}else o=n.subTaskName(t.sq);return o});return{order:n.option.assertsOrder,name:r}})}}();return"object"===("undefined"==typeof o?"undefined":_typeof(o))?o.v:void 0}},{key:"createLoader",value:function(e){var n=this,t=null;return _.isFunction(this.option.loaderFactory)||!function(){var e=new LoaderFactory_1.LoaderFactory;n.option.loaderFactory=function(n){return e.create(n)}}(),t=this.option.loaderFactory(e)}},{key:"printHelp",value:function(e){"en"===e?console.log("\n                /**\n                 * gulp [build] [--env production|development] [--config name] [--root path] [--watch] [--test] [--serve] [--release] [--task taskname]\n                 * @params\n                 *  --env  development or production;\n                 *  --config app setting\n                 *  --root path, set relative path of the development tool root.\n                 *  --watch  watch src file change or not. if changed will auto update to node service. \n                 *  --release release web app or not. if [--env production], default to release. \n                 *  --test  need auto load test file to node service.\n                 *  --deploy run deploy tasks to deploy project.  \n                 *  --serve start node web service or not.\n                 *  --task taskname  spruce task taskname\n                 **/"):console.log("\n                /**\n                 * gulp [build] [--env production|development] [--config name] [--root path] [--watch] [--test] [--serve] [--release] [--task taskname]\n                 * @params\n                 *  --env 发布环境 默认开发环境development;\n                 *  --config 设置配置文件;\n                 *  --root path, 设置编译环境相对路径\n                 *  --watch  是否需要动态监听文件变化\n                 *  --release 是否release编译, [--env production] 默认release \n                 *  --test  启动自动化测试\n                 *  --deploy 运行加载deploy tasks, 编译发布项目。  \n                 *  --serve  是否在开发模式下 开启node web服务\n                 *  --task taskname  运行单独任务taskname\n                 **/")}}],[{key:"create",value:function(n,t,r){var o=_.isArray(r)?{tasks:r}:r,a=new e(t,o);return o.setupTask=o.setupTask||"build",n.task(o.setupTask,function(e){var t=minimist(process.argv.slice(2),{string:"env",default:{env:process.env.NODE_ENV||"development"}});return a.run(n,t)}),n.task("default",function(){n.start(o.setupTask)}),a}}]),e}();exports.Development=Development;
//# sourceMappingURL=sourcemaps/tools.js.map
